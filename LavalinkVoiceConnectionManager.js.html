

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      LavalinkVoiceConnectionManager.js - Documentation
  </title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  
  <link type="text/css" rel="stylesheet" href="styles/collapse.css">
  

  
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      @TheSharks/Tyr
    </h3>

    

    <h3>Classes</h3><ul><li id="LavalinkNode-nav"><a href="LavalinkNode.html">LavalinkNode</a><ul class='methods'><li data-type="method" id="LavalinkNode-connect-nav"><a href="LavalinkNode.html#connect">connect</a></li><li data-type="method" id="LavalinkNode-destroy-nav"><a href="LavalinkNode.html#destroy">destroy</a></li><li data-type="method" id="LavalinkNode-loadTracks-nav"><a href="LavalinkNode.html#loadTracks">loadTracks</a></li><li data-type="method" id="LavalinkNode-send-nav"><a href="LavalinkNode.html#send">send</a></li></ul></li><li id="LavalinkVoiceConnectionManager-nav"><a href="LavalinkVoiceConnectionManager.html">LavalinkVoiceConnectionManager</a><ul class='methods'><li data-type="method" id="LavalinkVoiceConnectionManager-remapNodes-nav"><a href="LavalinkVoiceConnectionManager.html#remapNodes">remapNodes</a></li></ul></li><li id="Player-nav"><a href="Player.html">Player</a><ul class='methods'><li data-type="method" id="Player-destroy-nav"><a href="Player.html#destroy">destroy</a></li><li data-type="method" id="Player-disconnect-nav"><a href="Player.html#disconnect">disconnect</a></li><li data-type="method" id="Player-eq-nav"><a href="Player.html#eq">eq</a></li><li data-type="method" id="Player-play-nav"><a href="Player.html#play">play</a></li><li data-type="method" id="Player-seek-nav"><a href="Player.html#seek">seek</a></li><li data-type="method" id="Player-setVolume-nav"><a href="Player.html#setVolume">setVolume</a></li><li data-type="method" id="Player-stop-nav"><a href="Player.html#stop">stop</a></li><li data-type="method" id="Player-switchChannel-nav"><a href="Player.html#switchChannel">switchChannel</a></li><li data-type="method" id="Player-togglePlayback-nav"><a href="Player.html#togglePlayback">togglePlayback</a></li><li data-type="method" id="Player-updateVoiceState-nav"><a href="Player.html#updateVoiceState">updateVoiceState</a></li></ul></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        LavalinkVoiceConnectionManager.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>const LavalinkNode = require('./LavalinkNode')
const Player = require('./Player')
const { Collection } = require('eris')

/**
 * @param {Object[]} nodes An array of lavalink nodes to connect to
 * @param {String} nodes.host The address of the node
 * @param {String} nodes.password The password of the node
 * @param {Number} nodes.port The port of the node
 * @param {String} nodes.region The geographical region of the node
 * @param {Object} options
 * @param {String} options.userId The user ID from the client
 * @param {Number} options.shards How many shards the client is running
 * @param {Object} [options.regions] What regions to use
 * @param {String} [options.defaultRegion='us'] The default region to use if no regions correspond
 *
 * @see {@link https://abal.moe/Eris/docs/Collection|Eris documentation on Collection}
 */
class LavalinkVoiceConnectionManager extends Collection {
  constructor (nodes, options = {}) {
    super()
    this.nodes = nodes.map(x => {
      return new LavalinkNode({
        shards: options.shards,
        userId: options.userId,
        ...x
      })
    })
    this.nodes.forEach(x => x.on('message', this.onNodeMessage.bind(this)))
    this.pendingGuilds = {}
    this.regions = options.regions || {
      asia: ['singapore', 'hongkong', 'russia', 'japan', 'india', 'dubai'],
      eu: ['europe', 'amsterdam', 'london', 'frankfurt', 'eu-central', 'eu-west', 'vip-amsterdam'],
      us: ['us-west', 'us-east', 'us-central', 'us-south', 'brazil', 'vip-us-west', 'vip-us-east'],
      africa: ['southafrica'],
      australia: ['sidney']
    }
    this.defaultRegion = options.defaultRegion || 'us'
  }

  async join (guildID, channelID) {
    const player = this.get(guildID)
    if (player &amp;&amp; player.connected) {
      player.switchChannel(channelID)
      return Promise.resolve(player)
    }
    return new Promise((resolve, reject) => {
      this.pendingGuilds[guildID] = {
        channelID: channelID,
        res: resolve,
        rej: reject,
        timeout: setTimeout(() => {
          delete this.pendingGuilds[guildID]
          reject(new Error('Voice connection timeout'))
        }, 10000)
      }
    })
  }

  leave (guildID) {
    const player = this.get(guildID)
    if (!player) return
    player.disconnect()
    this.delete(guildID)
  }

  switch (guildID, channelID) {
    const player = this.get(guildID)
    if (!player) return
    player.switchChannel(channelID)
  }

  voiceServerUpdate (data) {
    if (this.pendingGuilds[data.guild_id] &amp;&amp; this.pendingGuilds[data.guild_id].timeout) {
      clearTimeout(this.pendingGuilds[data.guild_id].timeout)
      this.pendingGuilds[data.guild_id].timeout = null
    }
    let player = this.get(data.guild_id)
    if (!player) {
      if (!this.pendingGuilds[data.guild_id]) {
        return
      }
      player = new Player(this.selectBestLavalinkNode(data.endpoint), data.guild_id, data.shard)
      this.set(data.guild_id, player)
    }
    player.once('ready', () => {
      if (this.pendingGuilds[data.guild_id]) {
        this.pendingGuilds[data.guild_id].res(player)
        delete this.pendingGuilds[data.guild_id]
      }
    })
    player.once('disconnected', ctx => {
      if (this.pendingGuilds[data.guild_id]) {
        this.pendingGuilds[data.guild_id].rej(new Error(ctx.reason || 'Disconnected'))
        delete this.pendingGuilds[data.guild_id]
      }
      this.delete(data.guild_id)
    })
    player.connect({
      sessionId: data.session_id,
      guildId: data.guild_id,
      event: data
    })
  }

  selectBestLavalinkNode (endpoint) {
    const region = this.voiceRegionFromEndpoint(endpoint)
    const availableNodes = this.nodes.filter(x => x.connected).sort((a, b) => {
      const aload = a.stats.cpu ? (a.stats.cpu.systemLoad / a.stats.cpu.cores) * 100 : 0
      const bload = b.stats.cpu ? (b.stats.cpu.systemLoad / b.stats.cpu.cores) * 100 : 0
      return aload - bload
    })
    if (availableNodes.length === 0) throw new Error('No lavalink nodes connected that are able to handle connections')
    const regionalNodes = availableNodes.filter(x => x.region === region)
    if (regionalNodes.length === 0) return availableNodes[0]
    else return regionalNodes[0]
  }

  voiceRegionFromEndpoint (endpoint) {
    for (const key in this.regions) {
      for (const region of this.regions[key]) {
        if (endpoint.startsWith(region)) return key
      }
    }
    return this.defaultRegion
  }

  /**
   * Connect to new nodes
   * @param {Object[]} nodes An array of lavalink nodes to connect to
   * @param {String} nodes.host The address of the node
   * @param {String} nodes.password The password of the node
   * @param {Number} nodes.port The port of the node
   * @param {String} nodes.region The geographical region of the node
   * @param {Object} options
   * @param {String} options.userId The user ID from the client
   * @param {Number} options.shards How many shards the client is running
   * @param {Boolean} destructive Destroy connections to all current nodes?
   * @return {LavalinkNode[]} The nodes the module is connecting to now
   */
  remapNodes (nodes, options, destructive = false) {
    if (destructive) {
      if (this.nodes.length > 0) this.nodes.forEach(x => x.destroy())
      this.nodes = nodes.map(x => {
        return new LavalinkNode({
          shards: options.shards,
          userId: options.userId,
          ...x
        })
      })
    } else {
      const nodeAdresses = this.nodes.map(x => x.address)
      const newnodes = nodes.filter(x => !nodeAdresses.includes(`${x.host}:${x.port}`))
      newnodes.forEach(x => {
        this.nodes.push(new LavalinkNode({
          shards: options.shards,
          userId: options.userId,
          ...x
        }))
      })
    }

    this.nodes
      .filter(x => x.listenerCount('message') === 0)
      .forEach(x => x.on('message', this.onNodeMessage.bind(this)))

    return this.nodes
  }

  onNodeMessage (msg) {
    const player = this.get(msg.guildId)
    if (!player) return
    player.onNodeMessage(msg)
  }
}

module.exports = LavalinkVoiceConnectionManager
</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
